<!DOCTYPE html>
<html lang="en" class="h-full {% if user_settings.dark_mode == 1 %}dark{% endif %}">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Hans' chatbot</title>
	<link rel="icon" href="/static/favicon.ico" type="image/x-icon">

	<!-- HTMX -->
	<script src="https://unpkg.com/htmx.org@1.9.10"></script>
	<script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>

	<!-- Tailwind CSS -->
	<script src="https://cdn.tailwindcss.com?plugins=typography"></script>
	<script>
		tailwind.config = {
			darkMode: 'class',
			theme: {
				extend: {
					fontFamily: {
						sans: ['Inter', 'sans-serif'],
					},
					colors: {
						primary: '#2563eb', // Blue-600
						secondary: '#f3f4f6', // Gray-100
					}
				}
			}
		}
	</script>

	<!-- Fonts -->
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

	<!-- Highlight.js -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

	<!-- KaTeX -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
		integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
		integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8"
		crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
		integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05"
		crossorigin="anonymous"></script>

	<style>
		body {
			font-family: 'Inter', sans-serif;
		}

		/* Custom scrollbar for Webkit */
		::-webkit-scrollbar {
			width: 8px;
		}

		::-webkit-scrollbar-track {
			background: transparent;
		}

		::-webkit-scrollbar-thumb {
			background: #cbd5e1;
			border-radius: 4px;
		}

		::-webkit-scrollbar-thumb:hover {
			background: #94a3b8;
		}

		/* Dark mode scrollbar */
		.dark ::-webkit-scrollbar-thumb {
			background: #4b5563;
		}

		.dark ::-webkit-scrollbar-thumb:hover {
			background: #6b7280;
		}

		/* Cursor blink animation */
		@keyframes blink {
			50% {
				opacity: 0;
			}
		}

		.cursor-blink {
			animation: blink 1s infinite;
		}

		/* Right Sidebar Styles */
		#files-sidebar {
			transition: transform 0.3s ease-in-out;
		}

		#files-sidebar.collapsed {
			transform: translateX(100%);
			width: 0;
			overflow: hidden;
		}

		#files-sidebar:not(.collapsed) {
			transform: translateX(0);
			width: 300px;
			/* Default desktop width */
		}

		@media (max-width: 768px) {
			#files-sidebar:not(.collapsed) {
				width: 100%;
				position: absolute;
				right: 0;
				z-index: 50;
			}
		}
	</style>
</head>

<body
	class="bg-gray-50 dark:bg-gray-900 h-full flex flex-col items-center justify-center p-2 sm:p-3 transition-colors duration-200">

	<div
		class="relative w-full max-w-[98%] bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden flex h-[96vh] border border-gray-100 dark:border-gray-700 transition-colors duration-200">

		<!-- Mobile Overlay -->
		<div id="mobile-overlay" onclick="toggleSidebar()"
			class="absolute inset-0 bg-black/50 z-30 hidden md:hidden transition-opacity duration-300 opacity-0"></div>

		<!-- Sidebar -->
		<div id="sidebar"
			class="w-64 bg-white dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 flex flex-col transition-transform duration-300 absolute md:relative z-40 h-full -translate-x-full md:translate-x-0">
			<div class="p-4 border-b border-gray-200 dark:border-gray-800 flex flex-col gap-3">
				<button hx-post="/new-chat" hx-swap="none"
					class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-md px-4 py-2 flex items-center justify-center gap-2 transition-colors shadow-sm">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
						<path fill-rule="evenodd"
							d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
							clip-rule="evenodd" />
					</svg>
					New Chat
				</button>

				<!-- Auth Section -->
				{% if user %}
				<div class="flex items-center gap-3 p-2 bg-gray-50 dark:bg-gray-800 rounded-md">
					<img src="{{ user.picture }}" alt="User"
						class="w-8 h-8 rounded-full border border-gray-300 dark:border-gray-600">
					<div class="flex-1 min-w-0">
						<p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">{{ user.name }}</p>
						<p class="text-xs text-gray-500 dark:text-gray-400 truncate">{{ user.email }}</p>
					</div>
					<a href="/logout" class="text-xs text-red-500 hover:text-red-700" title="Logout">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
							stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
								d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
						</svg>
					</a>
				</div>
				{% else %}
				<a href="/login"
					class="w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-md px-4 py-2 flex items-center justify-center gap-2 transition-colors text-sm font-medium">
					<svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
						<path
							d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
							fill="#4285F4" />
						<path
							d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
							fill="#34A853" />
						<path
							d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
							fill="#FBBC05" />
						<path
							d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
							fill="#EA4335" />
						<path d="M1 1h22v22H1z" fill="none" />
					</svg>
					Sign in with Google
				</a>
				{% endif %}

			</div>

			<div class="flex-1 overflow-y-auto p-2 space-y-1" id="chat-list">
				<div class="text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider px-2 py-2">
					Previous Chats</div>
				{% for chat in conversations %}
				<div class="relative group">
					<button hx-get="/load-chat/{{ chat.id }}" hx-swap="none" class="w-full text-left px-3 py-2 rounded-md text-sm truncate transition-colors flex items-center gap-2
					{% if chat.id == current_session_id %}
						bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 font-medium
					{% else %}
						text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800
					{% endif %}">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-50 flex-shrink-0" fill="none"
							viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
								d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
						</svg>
						<span class="truncate flex-1">{{ chat.title }}</span>
					</button>
					<!-- Context Menu Button -->
					<button onclick="toggleMenu('menu-{{ chat.id }}')"
						class="absolute right-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition-opacity">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 dark:text-gray-400"
							fill="currentColor" viewBox="0 0 16 16">
							<path
								d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z" />
						</svg>
					</button>
					<!-- Dropdown Menu -->
					<div id="menu-{{ chat.id }}"
						class="hidden absolute right-0 top-8 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md shadow-lg z-50 min-w-[120px]">
						<button onclick="renameChat('{{ chat.id }}', '{{ chat.title }}')"
							class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
							<span>üè∑Ô∏è</span> Rename
						</button>
						<button hx-post="/archive-chat/{{ chat.id }}" hx-swap="none"
							class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
							<span>üì¶</span> Archive
						</button>
						<button hx-delete="/delete-chat/{{ chat.id }}" hx-swap="none"
							hx-confirm="Permanently delete this chat and all associated files?"
							class="w-full text-left px-3 py-2 text-sm hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400 flex items-center gap-2">
							<span>üóëÔ∏è</span> Delete
						</button>
					</div>
				</div>
				{% endfor %}
			</div>

			<div class="p-4 border-t border-gray-100 dark:border-gray-700">
				<button hx-get="/settings/system_instruction" hx-target="body" hx-swap="beforeend"
					class="w-full bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-200 border border-gray-200 dark:border-gray-600 font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 shadow-sm">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 dark:text-gray-400" fill="none"
						viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
					</svg>
					Settings
				</button>
			</div>
		</div>

		<!-- Main Chat Area -->
		<div class="flex-1 flex flex-col min-w-0">

			<!-- Header -->
			<div
				class="bg-white dark:bg-gray-800 border-b border-gray-100 dark:border-gray-700 p-4 flex justify-between items-center sticky top-0 z-10 transition-colors duration-200">
				<div class="flex items-center gap-3">
					<!-- Hamburger Menu (Mobile) -->
					<button onclick="toggleSidebar()"
						class="md:hidden text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 p-2 -ml-2 rounded-md">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
							stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
								d="M4 6h16M4 12h16M4 18h16" />
						</svg>
					</button>

					<img src="/static/chatbot_icon.png" alt="Chatbot Icon" class="w-8 h-8 rounded-lg object-contain">

					<div id="chat-title-container" class="flex items-center gap-1 group">
						<h1 id="chat-title-header"
							class="font-semibold text-gray-800 dark:text-gray-100 text-lg tracking-tight ml-2">{{
							current_chat_title }}</h1>
						<button hx-get="/rename-chat-ui" hx-target="#chat-title-container" hx-swap="outerHTML"
							class="opacity-0 group-hover:opacity-100 p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-opacity"
							title="Rename Chat">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 hover:text-blue-500"
								fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
							</svg>
						</button>
					</div>
				</div>
				<div class="flex items-center gap-2">
					<!-- Dark Mode Toggle -->



					<button hx-post="/clear-file-context" hx-target="#chat-window" hx-swap="afterbegin"
						class="text-xs font-medium text-gray-500 dark:text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 transition-colors px-3 py-1.5 rounded-md hover:bg-blue-50 dark:hover:bg-gray-700">
						üìé Clear File Context
					</button>

					<!-- Files Sidebar Toggle -->
					<button onclick="toggleFilesSidebar()"
						class="p-2 text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 rounded-md transition-colors"
						title="Generated Files">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
							stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
								d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 011.414.414l5 5a1 1 0 01.414 1.414V19a2 2 0 01-2 2z" />
						</svg>
					</button>
				</div>
			</div>

			<!-- Chat Window -->
			<div id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth">
				{% if chat_history %}
				{{ chat_history | safe }}
				{% else %}
				<div id="welcome-screen"
					class="flex flex-col items-center justify-center min-h-[60vh] text-center px-4">
					<div
						class="bg-blue-50/50 dark:bg-blue-900/10 p-8 rounded-3xl border border-blue-100/50 dark:border-blue-800/30 max-w-2xl w-full">
						<div
							class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-500/20">
							<img src="/static/chatbot_icon.png" alt="Icon"
								class="w-10 h-10 object-contain brightness-0 invert">
						</div>
						<h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4 tracking-tight">
							{{ welcome_data.message }}
						</h2>
						<p class="text-gray-500 dark:text-gray-400 mb-8 text-sm">
							Choose a starter prompt below or type your own message to begin.
						</p>
						<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
							{% for prompt in welcome_data.prompts %}
							<button onclick="setInput(this.getAttribute('data-prompt'))" data-prompt="{{ prompt }}"
								class="text-sm text-left px-5 py-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl hover:border-blue-500 dark:hover:border-blue-400 hover:shadow-xl hover:shadow-blue-500/5 transition-all duration-200 text-gray-700 dark:text-gray-200 group flex items-center justify-between">
								<span class="truncate">{{ prompt }}</span>
								<svg xmlns="http://www.w3.org/2000/svg"
									class="h-4 w-4 text-blue-500 opacity-0 group-hover:opacity-100 transition-all transform group-hover:translate-x-1"
									fill="none" viewBox="0 0 24 24" stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
										d="M13 7l5 5m0 0l-5 5m5-5H6" />
								</svg>
							</button>
							{% endfor %}
						</div>
					</div>
				</div>
				{% endif %}
			</div>

			<!-- Input Area -->
			<div
				class="p-4 bg-white dark:bg-gray-800 border-t border-gray-100 dark:border-gray-700 transition-colors duration-200">

				<!-- File Preview -->
				<div id="file-preview" class="hidden mb-3 relative inline-block group">
					<div
						class="flex items-center gap-2 bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-2 pr-8">
						<div id="preview-icon" class="text-blue-500">
							<!-- Icon will be injected here -->
						</div>
						<div class="flex flex-col">
							<span id="preview-name"
								class="text-xs font-medium text-gray-700 dark:text-gray-300 truncate max-w-[150px]">filename.ext</span>
							<span id="preview-type" class="text-[10px] text-gray-400 dark:text-gray-500">TYPE</span>
						</div>
						<img id="preview-img" src="" alt="Preview" class="hidden h-10 w-10 object-cover rounded">
					</div>
					<button type="button" onclick="clearFile()"
						class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 shadow-sm transition-transform hover:scale-110">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
							<path fill-rule="evenodd"
								d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
								clip-rule="evenodd" />
						</svg>
					</button>
				</div>

				<form hx-post="/chat" hx-target="#chat-window" hx-swap="beforeend scroll:bottom"
					hx-encoding="multipart/form-data"
					hx-on::after-request="this.reset(); clearFile(); document.getElementById('chat-input').style.height = 'auto'"
					class="relative flex items-center gap-2">

					<input type="file" name="file" id="file-input" class="hidden" onchange="previewFile(this)">

					<button type="button" onclick="document.getElementById('file-input').click()"
						class="p-3 text-gray-400 dark:text-gray-500 hover:text-blue-600 dark:hover:text-blue-400 transition-colors rounded-xl hover:bg-blue-50 dark:hover:bg-gray-700"
						title="Upload File">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
							stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
								d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
						</svg>
					</button>

					<textarea id="chat-input" name="prompt" placeholder="Type your message..." required rows="1"
						oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'"
						onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); setInput(this.value); }"
						class="w-full pl-4 pr-12 py-3.5 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 dark:focus:border-blue-400 transition-all text-gray-700 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500 resize-none overflow-hidden"
						style="max-height: 200px;"></textarea>

					<button type="submit"
						class="absolute right-2 p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed group">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
							class="w-5 h-5 transform group-hover:translate-x-0.5 transition-transform">
							<path
								d="M3.105 2.289a.75.75 0 00-.826.95l1.414 4.925A1.5 1.5 0 005.135 9.25h6.115a.75.75 0 010 1.5H5.135a1.5 1.5 0 00-1.442 1.086l-1.414 4.926a.75.75 0 00.826.95 28.896 28.896 0 0015.293-7.154.75.75 0 000-1.115A28.897 28.897 0 003.105 2.289z" />
						</svg>
					</button>
				</form>
				<div class="text-center mt-2">
					<p class="text-[10px] text-gray-400 dark:text-gray-500">Built with HTMX & FastAPI</p>
				</div>
			</div>
		</div>

		<!-- Right Files Sidebar -->
		<div id="files-sidebar"
			class="collapsed flex flex-col bg-white dark:bg-gray-900 border-l border-gray-200 dark:border-gray-800 transition-all duration-300">
			<div
				class="p-4 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50">
				<h2 class="font-semibold text-gray-800 dark:text-gray-100 flex items-center gap-2">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none"
						viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
					</svg>
					Generated Files
				</h2>
				<button onclick="toggleFilesSidebar()"
					class="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition-colors">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none"
						viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							d="M6 18L18 6M6 6l12 12" />
					</svg>
				</button>
			</div>

			<!-- Files List (HTMX populated) -->
			<div id="files-list-container" hx-get="/generated-files" hx-trigger="load, refreshFiles from:body"
				class="flex-1 overflow-y-auto p-4 space-y-3">
				<div class="flex justify-center p-4">
					<div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
				</div>
			</div>
		</div>

	</div>

	<script>
		// Dark Mode Toggle
		function toggleDarkMode() {
			const html = document.documentElement;
			const isDark = html.classList.contains('dark');
			const newDarkMode = isDark ? 0 : 1;

			if (isDark) {
				html.classList.remove('dark');
			} else {
				html.classList.add('dark');
			}

			// Persist to DB
			const formData = new FormData();
			formData.append('dark_mode', newDarkMode);
			fetch('/toggle-dark-mode', {
				method: 'POST',
				body: formData
			});
		}

		// Context Menu Functions
		function toggleMenu(menuId) {
			// Close all other menus first
			document.querySelectorAll('[id^="menu-"]').forEach(menu => {
				if (menu.id !== menuId) {
					menu.classList.add('hidden');
				}
			});

			// Toggle the clicked menu
			const menu = document.getElementById(menuId);
			menu.classList.toggle('hidden');
		}

		// Mobile Sidebar Toggle
		function toggleSidebar() {
			const sidebar = document.getElementById('sidebar');
			const overlay = document.getElementById('mobile-overlay');

			if (sidebar.classList.contains('-translate-x-full')) {
				// Open
				sidebar.classList.remove('-translate-x-full');
				overlay.classList.remove('hidden');
				// Small timeout to allow display:block to apply before opacity transition
				setTimeout(() => {
					overlay.classList.remove('opacity-0');
				}, 10);
			} else {
				// Close
				sidebar.classList.add('-translate-x-full');
				overlay.classList.add('opacity-0');
				setTimeout(() => {
					overlay.classList.add('hidden');
				}, 300); // Match transition duration
			}
		}

		// Close menus when clicking outside
		document.addEventListener('click', function (event) {
			if (!event.target.closest('[id^="menu-"]') && !event.target.closest('button[onclick^="toggleMenu"]')) {
				document.querySelectorAll('[id^="menu-"]').forEach(menu => {
					menu.classList.add('hidden');
				});
			}
		});

		// Rename Chat Function
		function renameChat(chatId, currentTitle) {
			const newTitle = prompt('Enter new chat name:', currentTitle);
			if (newTitle && newTitle !== currentTitle) {
				// Create a form and submit via HTMX
				const formData = new FormData();
				formData.append('new_title', newTitle);

				fetch(`/rename-chat/${chatId}`, {
					method: 'POST',
					body: formData
				}).then(() => {
					// Reload the page to show updated title
					window.location.reload();
				});
			}
		}

		// Files Sidebar Toggle
		function toggleFilesSidebar() {
			const sidebar = document.getElementById('files-sidebar');
			const isCollapsed = sidebar.classList.contains('collapsed');

			if (isCollapsed) {
				sidebar.classList.remove('collapsed');
				// Refresh contents when opening
				htmx.trigger('#files-list-container', 'refreshFiles');
			} else {
				sidebar.classList.add('collapsed');
			}
		}




		// Add Copy Buttons to Code Blocks
		function addCopyButtons(content) {
			content.querySelectorAll('pre').forEach((pre) => {
				// Check if button already exists
				if (pre.querySelector('.copy-btn')) return;

				// Create container if not relative
				if (getComputedStyle(pre).position === 'static') {
					pre.style.position = 'relative';
				}

				const btn = document.createElement('button');
				// Reduced padding to p-0.5 and added flex/justify-center to make it as small as possible
				btn.className = 'copy-btn absolute top-2 right-2 bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white rounded p-0.5 transition-all opacity-0 group-hover:opacity-100 focus:opacity-100 shadow-sm border border-gray-600 z-10 flex items-center justify-center';
				btn.innerHTML = `
					<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
					</svg>
				`;
				btn.title = "Copy code";

				btn.addEventListener('click', async (e) => {
					e.preventDefault();
					e.stopPropagation();

					// Get code content - simplified to avoid getting button text
					// Clone the pre, remove the button, then get text
					const clone = pre.cloneNode(true);
					const existingBtn = clone.querySelector('.copy-btn');
					if (existingBtn) existingBtn.remove();

					const code = clone.innerText || clone.textContent;

					try {
						// Fallback method for non-secure contexts (HTTP)
						if (!navigator.clipboard && document.execCommand) {
							const textarea = document.createElement('textarea');
							textarea.value = code.trim();
							textarea.style.position = 'fixed'; // Prevent scrolling
							textarea.style.left = '-9999px';
							document.body.appendChild(textarea);
							textarea.select();
							document.execCommand('copy');
							document.body.removeChild(textarea);
						} else {
							await navigator.clipboard.writeText(code.trim());
						}

						// Success feedback
						const originalHtml = btn.innerHTML;
						btn.innerHTML = `
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
							</svg>
						`;
						setTimeout(() => {
							btn.innerHTML = originalHtml;
						}, 2000);
					} catch (err) {
						console.error('Failed to copy:', err);
						btn.innerHTML = `
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
							</svg>
						`;
						setTimeout(() => {
							btn.innerHTML = originalHtml;
						}, 2000);
					}
				});

				// Add group class to pre for hover effect if not present
				pre.classList.add('group');
				pre.appendChild(btn);
			});
		}

		// Add Copy Buttons to Whole Messages (AI Responses)
		function addMessageCopyButtons(content) {
			// Target AI messages by their specific border-radius class
			content.querySelectorAll('.rounded-tl-sm').forEach((msgDiv) => {
				// Check if button already exists (to avoid duplicates on re-scans)
				if (msgDiv.querySelector('.msg-copy-btn')) return;

				// Make relative to position button
				if (getComputedStyle(msgDiv).position === 'static') {
					msgDiv.style.position = 'relative';
				}

				// Ensure group class for hover visibility
				msgDiv.classList.add('group');

				const btn = document.createElement('button');
				// Use msg-copy-btn class to distinguish
				btn.className = 'msg-copy-btn absolute top-2 right-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-400 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 rounded p-1 transition-all opacity-0 group-hover:opacity-100 focus:opacity-100 shadow-sm border border-gray-200 dark:border-gray-600 z-10 hidden sm:flex items-center justify-center';
				btn.innerHTML = `
					<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
					</svg>
				`;
				btn.title = "Copy message";

				btn.addEventListener('click', async (e) => {
					e.preventDefault();
					e.stopPropagation();

					// Logic to copy text content of the message
					// Clone node to safely remove buttons before extracting text
					const clone = msgDiv.cloneNode(true);

					// Remove all copy buttons (both message and code block ones) from clone
					clone.querySelectorAll('button').forEach(b => b.remove());
					clone.querySelectorAll('.copy-btn').forEach(b => b.remove());
					clone.querySelectorAll('.msg-copy-btn').forEach(b => b.remove());
					// Remove suggestions
					const suggestions = clone.querySelector('.flex.flex-wrap.gap-2');
					if (suggestions) suggestions.remove();

					const text = clone.innerText || clone.textContent;

					try {
						// Fallback method for non-secure contexts (HTTP)
						if (!navigator.clipboard && document.execCommand) {
							const textarea = document.createElement('textarea');
							textarea.value = text.trim();
							textarea.style.position = 'fixed';
							textarea.style.left = '-9999px';
							document.body.appendChild(textarea);
							textarea.select();
							document.execCommand('copy');
							document.body.removeChild(textarea);
						} else {
							await navigator.clipboard.writeText(text.trim());
						}

						// Success feedback
						const originalHtml = btn.innerHTML;
						btn.innerHTML = `
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
							</svg>
						`;
						setTimeout(() => {
							btn.innerHTML = originalHtml;
						}, 2000);
					} catch (err) {
						console.error('Failed to copy message:', err);
					}
				});

				msgDiv.appendChild(btn);
			});
		}

		// Add Copy Buttons to User Messages
		function addUserMessageCopyButtons(content) {
			content.querySelectorAll('.user-msg-bubble').forEach((msgDiv) => {
				if (msgDiv.querySelector('.user-copy-btn')) return;
				if (getComputedStyle(msgDiv).position === 'static') {
					msgDiv.style.position = 'relative';
				}
				msgDiv.classList.add('group');

				const btn = document.createElement('button');
				btn.className = 'user-copy-btn absolute top-2 right-2 bg-blue-500 hover:bg-blue-400 text-blue-100 dark:text-blue-100 rounded p-1 transition-all opacity-0 group-hover:opacity-100 focus:opacity-100 shadow-sm border border-blue-400 z-10 hidden sm:flex items-center justify-center';
				btn.innerHTML = `
					<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
					</svg>
				`;
				btn.title = "Copy prompt";

				btn.addEventListener('click', async (e) => {
					e.preventDefault();
					e.stopPropagation();

					const clone = msgDiv.cloneNode(true);
					clone.querySelectorAll('button').forEach(b => b.remove());
					clone.querySelectorAll('.user-copy-btn').forEach(b => b.remove());

					const text = clone.innerText || clone.textContent;

					try {
						if (!navigator.clipboard && document.execCommand) {
							const textarea = document.createElement('textarea');
							textarea.value = text.trim();
							textarea.style.position = 'fixed';
							textarea.style.left = '-9999px';
							document.body.appendChild(textarea);
							textarea.select();
							document.execCommand('copy');
							document.body.removeChild(textarea);
						} else {
							await navigator.clipboard.writeText(text.trim());
						}

						const originalHtml = btn.innerHTML;
						btn.innerHTML = `
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
							</svg>
						`;
						setTimeout(() => {
							btn.innerHTML = originalHtml;
						}, 2000);
					} catch (err) {
						console.error('Failed to copy prompt:', err);
					}
				});

				msgDiv.appendChild(btn);
			});
		}

		// Centralized Math Rendering with Diagnostics
		function renderMath(element, source = "unknown") {
			try {
				const mathConfig = {
					delimiters: [
						{ left: '$$', right: '$$', display: true },
						{ left: '$', right: '$', display: false },
						{ left: '\\(', right: '\\)', display: false },
						{ left: '\\[', right: '\\]', display: true }
					],
					throwOnError: false
				};

				const renderer = typeof renderMathInElement !== 'undefined' ? renderMathInElement : window.renderMathInElement;

				if (renderer) {
					// Add a small delay for dynamic content to ensure DOM is ready
					const delay = (source === "htmx") ? 50 : 0;
					setTimeout(() => {
						renderer(element, mathConfig);
						console.log(`[Math] Rendered ${source} at`, new Date().toLocaleTimeString());
					}, delay);
				} else {
					console.error(`[Math] KaTeX renderer NOT found for ${source}! Check script loading.`);
				}
			} catch (e) {
				console.error(`[Math] Error in ${source}:`, e);
			}
		}

		// Use htmx.onLoad for reliable rendering of new content (including OOB swaps)
		htmx.onLoad(function (content) {
			// 1. Render Math
			renderMath(content, "htmx");

			// 2. Add copy buttons
			try {
				addCopyButtons(content);
				addMessageCopyButtons(content);
				addUserMessageCopyButtons(content);
			} catch (e) {
				console.error("Error adding copy buttons:", e);
			}

			// 3. Highlight code
			try {
				content.querySelectorAll('pre code').forEach((block) => {
					if (typeof hljs !== 'undefined') {
						hljs.highlightElement(block);
					}
				});
			} catch (e) {
				console.error("Error highlighting code:", e);
			}
		});

		// Listen for HTMX swaps to handle scrolling
		document.body.addEventListener('htmx:afterSwap', function (evt) {
			// Auto-scroll to bottom on new content
			const chatWindow = document.getElementById('chat-window');
			if (chatWindow) {
				chatWindow.scrollTop = chatWindow.scrollHeight;
			}
		});

		// Initial Math Render (if history loaded)
		document.addEventListener("DOMContentLoaded", function () {
			renderMath(document.body, "initial");
		});

		// File Preview Logic
		function previewFile(input) {
			if (input.files && input.files[0]) {
				const file = input.files[0];
				const previewDiv = document.getElementById('file-preview');
				const previewName = document.getElementById('preview-name');
				const previewType = document.getElementById('preview-type');
				const previewImg = document.getElementById('preview-img');
				const previewIcon = document.getElementById('preview-icon');

				previewName.textContent = file.name;
				previewType.textContent = file.type || 'Unknown';
				previewDiv.classList.remove('hidden');

				// Reset
				previewImg.classList.add('hidden');
				previewIcon.innerHTML = '';

				if (file.type.startsWith('image/')) {
					var reader = new FileReader();
					reader.onload = function (e) {
						previewImg.src = e.target.result;
						previewImg.classList.remove('hidden');
					}
					reader.readAsDataURL(file);
				} else {
					// Generic File Icon
					previewIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 011.414.414l5 5a1 1 0 01.414 1.414V19a2 2 0 01-2 2z" /></svg>`;
				}
			}
		}

		function clearFile() {
			document.getElementById('file-input').value = '';
			document.getElementById('file-preview').classList.add('hidden');
			document.getElementById('preview-img').src = '';
		}

		// Simple scroll to bottom behavior
		function scrollToBottom() {
			const chatWindow = document.getElementById('chat-window');
			chatWindow.scrollTop = chatWindow.scrollHeight;
		}

		// Call scroll to bottom after HTMX swaps content
		document.body.addEventListener('htmx:afterSwap', function (evt) {
			// Only trigger on chat messages, not on other swaps
			if (evt.detail.target.id === 'chat-window') {
				setTimeout(scrollToBottom, 50); // Small delay to ensure content is rendered
			}
		});

		// Also call on SSE message updates
		document.body.addEventListener('htmx:sseMessage', function (evt) {
			// For streaming, we want to stick to bottom if already near bottom or if it's a new message
			scrollToBottom();
		});

		// Initial scroll on load
		document.addEventListener("DOMContentLoaded", function () {
			scrollToBottom();
		});

		// Helper to set input value from suggestion chips
		function setInput(text) {
			const input = document.getElementById('chat-input');
			if (input) {
				input.value = text;
				input.focus();
				// Auto-submit the form
				const form = input.closest('form');
				if (form) {
					htmx.trigger(form, 'submit');
				}
			}
		}
	</script>
</body>

</html>